######################################################
##
##  Sokoban:
##
##  The classic block-pushing game of Sokoban.
##
##  John Earnest
##
######################################################

:image grid-tiles   "sokotiles.png"  8  8
:image sprite-tiles "sokobot.png"   16 24
:array sprites 1024 0

:include "../Sprites.fs"
:include "../Grid.fs"
:include "../Util.fs"
:include "../Print.fs"

:const player-type 1
:const block-type  2
:const target-type 3

:array sprite-id   256 0
:array object-type 256 0
: type?  object-type + @ ;
: type!  object-type + ! ;
: player 0 sprite-id + @ ;

:data level1
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8 -1 -1 -1 
	-1 -1  8 12 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 14  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  5  1  0  1  0  1  5  1  5  1  0  1  0  1  0  1  5  1  0  1  0  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  5  1  0  1  0  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1 10 11  0  1 10 29 29 11  0  1  0  1  0  1  0  1  0  1  0  1  0  1  5  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 31 15 16 17 31  8  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1 31 15  0  1 31  8  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  2  3  2  3 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 26 27 16 17 26 13 13 27 16 17 16 17 16 17 16 17 16 17 16 17 16 17 18 19 18 19 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  2  3  2  3 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 18 19 18 19 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1 10 29 29 29 29 11  0  1  0  1  0  1 10 11  0  1  0  1  2  3  2  3 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 26 13 13 13 13 27 16 17 16 17 16 17 31 15 16 17 16 17 18 19 18 19 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  4  1 31 15  0  1  0  1  0  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31 15 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 28 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 30 28 29 29 29 29 29 29 29 29 30  8 -1 -1 -1 
	-1 -1  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 

:data level2
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8  8  8  8  8  8  8  8  8  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 12 13 13 13 13 13 13 14  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15  0  1  0  1  0  1 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15 16 17 16 17 16 17 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15  0  1  0  1  0  1 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15 16 17 16 17 16 17 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15  5  1  0  1  0  1 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15 16 17 16 17 16 17 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1  8  8  8  8  8 15  0  1  0  1  5  1 31  8  8  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1  8 12 13 13 13 27 16 17 16 17 16 17 26 13 14  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1  8 15  0  1  0  1  5  1  0  1  5  1  0  1 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1  8  8  8  8  8 15  0  1 10 11  0  1 10 29 29 11  0  1 31  8 -1 -1 -1 -1  8  8  8  8  8  8  8  8  8  8  8  8 -1 -1 -1 
	-1 -1  8 12 13 13 13 27 16 17 31 15 16 17 31  8  8 15 16 17 31  8 -1 -1 -1 -1  8 12 13 13 13 13 13 13 13 13 14  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1 31 15  0  1 31  8  8 15  0  1 31  8  8  8  8  8  8 15  0  1  0  1  2  3  2  3 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 26 27 16 17 26 13 13 27 16 17 26 13 13 13 13 13 13 27 16 17 16 17 18 19 18 19 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  5  1  0  1  0  1  5  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  2  3  2  3 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 18 19 18 19 31  8 -1 -1 -1 
	-1 -1  8 28 29 29 29 29 29 29 29 11  0  1 10 29 29 29 29 11  0  1 10 11  4  1 10 11  0  1  0  1  2  3  2  3 31  8 -1 -1 -1 
	-1 -1  8  8  8  8  8  8  8  8  8 15 16 17 26 13 13 13 13 27 16 17 31 15 16 17 31 15 16 17 16 17 18 19 18 19 31  8 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15  0  1  0  1  0  1  0  1  0  1 31 28 29 29 30 28 29 29 29 29 29 29 29 29 30  8 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15 16 17 16 17 16 17 16 17 16 17 31  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 28 29 29 29 29 29 29 29 29 29 29 30  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8  8  8  8  8  8  8  8  8  8  8  8  8  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1  

:var object-count

: level! ( data -- )
	# clear objects
	255 for
		i sprite-id i + !
		0 i type!
	next
	1 object-count !
	
	# set GP
	GP !
	
	# find/init objects
	29 for
		39 for
			i j tile-grid@ @
			dup 4 = if # player start point
				16x24 0
				i 8 * j 1 - 8 * player >sprite
				player-type player type!
			then
			dup 5 = if # block
				16x24 7
				i 8 * j 1 - 8 * object-count @ >sprite
				block-type object-count @ type!
				object-count inc@
			then
			dup 2 = if # block target
				16x16 invisible 0
				i 8 * j 8 * object-count @ >sprite
				target-type object-count @ type!
				object-count inc@
			then
			drop
		next
	next
;

: sort-sprites ( -- )
	15 for
		i
		i for
			dup py i py <
			if drop i then
		next

		# swap mappings in the id table:
		dup sprite-id indexof
		  i sprite-id indexof swap@

		# swap entries in the type table:
		dup object-type +
		  i object-type + swap@

		# swap sprite registers:
		sprite@ i sprite@
		3 for
			over i +
			over i +
			swap@
		next
		2drop
	next
;

: has-block? ( x y -- flag )
	false -rot
	15 for
		2dup i c-sprite? i type? block-type = and >r
		rot r> or -rot
	next
	2drop
;

: blocked? ( dx2 dy2 dx1 dy1 -- flag )
	player py + >r player px + >r
	i j c-tile? if rdrop rdrop 2drop true exit then
	i j has-block? if
		swap r> + swap r> +
		2dup c-tile? -rot
		has-block? or
	else
		rdrop rdrop 2drop false
	then
;

:var pblock
: push ( dx dy x y -- )
	player py + swap player px + swap
	15 for
		2dup i c-sprite? i type? block-type = and
		if
			i pblock ! >r >r
			over pblock @ px + pblock @ px!
			dup  pblock @ py + pblock @ py!
			r> r>
		then
	next
	2drop
	player py + player py!
	player px + player px!
;

                  # down        # up          # left        # right
:data anim-frame  1  0  1  0    2  3  2  3    5  6  5  4     5  6  5  4
:data anim-flip   0  0 -1  0    0  0  0 -1    0  0  0  0    -1 -1 -1 -1
:data anim-next   1  2  3  0    5  6  7  4    9 10 11  8    13 14 15 12
:var  animation
: animate-player
	sync sync
	4 mod exitif
	animation @
	dup anim-frame + @ player tile!
	dup anim-flip  + @ if player face-right else player face-left then
	anim-next + @ animation !
;

: move-player
	keys key-lf and if
		5 player tile! player face-left
		-16 0 -15 9 blocked? exitif
		9 animation !
		15 for
			-1 0 0 9 push
			i animate-player			
		next
	then
	keys key-rt and if
		5 player tile! player face-right
		16 0 17 9 blocked? exitif
		13 animation !
		15 for
			1 0 16 9 push
			i animate-player
		next
	then
	keys key-up and if
		2 player tile!
		0 -16 1 -7 blocked? exitif
		5 animation !
		15 for
			0 -1 1 8 push
			i animate-player
		next
	then
	keys key-dn and if
		0 player tile!
		0 16 1 25 blocked? exitif
		0 animation !
		15 for
			0 1 1 24 push
			i animate-player
		next
	then
;

: main
	level1 level!

	loop
		sort-sprites
		move-player
		sync
	again
;