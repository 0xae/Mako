######################################################
##
##  Sokoban:
##
##  The classic block-pushing game of Sokoban.
##
##  John Earnest
##
######################################################

:image grid-tiles   "sokotiles.png"  8  8
:image sprite-tiles "sokobot.png"   16 24
:array sprites 1024 0

:include "../Sprites.fs"
:include "../Grid.fs"
:include "../Util.fs"
:include "../Print.fs"

:const player-type 1
:const block-type  2
:const target-type 3

:array sprite-id   256 0
:array object-type 256 0
: type?  object-type + @ ;
: type!  object-type + ! ;
: player 0 sprite-id + @ ;

:data level1

	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8 -1 -1 -1 
	-1 -1  8 12 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 13 14  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  5  1  0  1  0  1  5  1  5  1  0  1  0  1  0  1  5  1  0  1  0  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  5  1  0  1  0  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1 10 11  0  1 10 29 29 11  0  1  0  1  0  1  0  1  0  1  0  1  0  1  5  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 31 15 16 17 31  8  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1 31 15  0  1 31  8  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  2  3  2  3 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 26 27 16 17 26 13 13 27 16 17 16 17 16 17 16 17 16 17 16 17 16 17 18 19 18 19 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  2  3  2  3 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 18 19 18 19 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1 10 29 29 29 29 11  0  1  0  1  0  1 10 11  0  1  0  1  2  3  2  3 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 26 13 13 13 13 27 16 17 16 17 16 17 31 15 16 17 16 17 18 19 18 19 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  4  1 31 15  0  1  0  1  0  1  0  1 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 31 15 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 
	-1 -1  8 28 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 29 30 28 29 29 29 29 29 29 29 29 30  8 -1 -1 -1 
	-1 -1  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 

:data level2

	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8  8  8  8  8  8  8  8  8  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 12 13 13 13 13 13 13 14  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15  0  1  0  1  0  1 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15 16 17 16 17 16 17 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15  0  1  0  1  0  1 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15 16 17 16 17 16 17 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15  0  1  0  1  0  1 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15 16 17 16 17 16 17 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1  8  8  8  8  8 15  0  1  0  1  0  1 31  8  8  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1  8 12 13 13 13 27 16 17 16 17 16 17 26 13 14  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 31  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1  8  8  8  8  8 15  0  1 10 11  0  1 10 29 29 11  0  1 31  8 -1 -1 -1 -1  8  8  8  8  8  8  8  8  8  8  8  8 -1 -1 -1 
	-1 -1  8 12 13 13 13 27 16 17 31 15 16 17 31  8  8 15 16 17 31  8 -1 -1 -1 -1  8 12 13 13 13 13 13 13 13 13 14  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1 31 15  0  1 31  8  8 15  0  1 31  8  8  8  8  8  8 15  0  1  0  1  2  3  2  3 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 26 27 16 17 26 13 13 27 16 17 26 13 13 13 13 13 13 27 16 17 16 17 18 19 18 19 31  8 -1 -1 -1 
	-1 -1  8 15  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  0  1  2  3  2  3 31  8 -1 -1 -1 
	-1 -1  8 15 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 16 17 18 19 18 19 31  8 -1 -1 -1 
	-1 -1  8 28 29 29 29 29 29 29 29 11  0  1 10 29 29 29 29 11  0  1 10 11  0  1 10 11  0  1  0  1  2  3  2  3 31  8 -1 -1 -1 
	-1 -1  8  8  8  8  8  8  8  8  8 15 16 17 26 13 13 13 13 27 16 17 31 15 16 17 31 15 16 17 16 17 18 19 18 19 31  8 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15  0  1  0  1  0  1  0  1  0  1 31 28 29 29 30 28 29 29 29 29 29 29 29 29 30  8 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 15 16 17 16 17 16 17 16 17 16 17 31  8  8  8  8  8  8  8  8  8  8  8  8  8  8  8 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8 28 29 29 29 29 29 29 29 29 29 29 30  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1  8  8  8  8  8  8  8  8  8  8  8  8  8  8 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 
	-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 

:var object-count

: level! ( data -- )
	# clear objects
	255 for
		i sprite-id i + !
		0 i type!
	next
	1 object-count !
	
	# set GP
	GP !
	
	# find/init objects
	29 for
		39 for
			i j tile-grid@ @
			dup 4 = if # player start point
				16x24 0
				i 8 * j 1 - 8 * player >sprite
				player-type player type!
			then
			dup 5 = if # block
				16x24 7
				i 8 * j 1 - 8 * object-count @ >sprite
				block-type object-count @ type!
				object-count inc@
			then
			dup 2 = if # block target
				16x16 invisible 0
				i 8 * j 8 * object-count @ >sprite
				target-type object-count @ type!
				object-count inc@
			then
			drop
		next
	next
;

: sort-sprites ( -- )
	15 for
		i
		i for
			dup py i py <
			if drop i then
		next

		# swap mappings in the id table:
		dup sprite-id indexof
		  i sprite-id indexof swap@

		# swap entries in the type table:
		dup object-type +
		  i object-type + swap@

		# swap sprite registers:
		sprite@ i sprite@
		3 for
			over i +
			over i +
			swap@
		next
		2drop
	next
;

: c-objects? ( x y -- flag )
	2dup c-tile? if 2drop true exit then
	15 for
		2dup i c-sprite? i type? block-type = and
		if rdrop 2drop true exit then
	next
	2drop false
;

: move-player
	keys key-lf and if
		5 player tile! player face-left
		player px 15 - player py 9 + c-objects? exitif
		
		15 for
			player px 1 - player px!
			sync
		next
	then
	keys key-rt and if
		5 player tile! player face-right
		player px 17 + player py 9 + c-objects? exitif
		
		15 for
			player px 1 + player px!
			sync
		next
	then
	keys key-up and if
		2 player tile!
		player px 1 + player py c-objects? exitif

		15 for
			player py 1 - player py!
			sync
		next
	then
	keys key-dn and if
		0 player tile!
		player px 1 + player py 24 + c-objects? exitif
		15 for
			player py 1 + player py!
			sync
		next
	then
;

: main
	level1 level!

	loop
		sort-sprites
		move-player
		sync
	again
;